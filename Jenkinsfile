// Define secret variables
def AWSCRIPKEY = 'LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS1FJQkFBS0NBZ0VBcVNDZ3FlQzEyWkF0UDI1bzA4NXNodTBBWWVQVnBpVWhUMjRUVWJwUzMwOGtLSjRPCjdUY2xYTUZmSWE1ZXAvTmFuSHdkaERwNVBUK0JtZWdGeHNvN3V6Q0pHejg3RnhaenpLRkJxeGdlVlRKdlBzWEoKWXB1T1lsVVBQZm1Pb256ZVJXRE5vUkdBZlJvWGhIWUlrRi82Nytqd1BxcXV6c2pjcE8ydlJVSzJRVDlqVHYzTApSR2Q0N09XOHVRZTdDNXQ1MEFqVmx1WkZtQ0R3bVB4SlU1cU01b0RqYnJOby9tdkJmWXo1WXRTbCs5d0dha1ArCktRYmRCQXRldHFlRlRTMlYwYldCdEs1NC9KRE0yQmRtNGxxUjJTMjQ4SHkzL1BPa2tWOVNCenJJazlaMmhBMWsKQ1BTc0RudDlvdlNwMkIwS3MyeEpYeVZncFVJZmI0MzBEVzRVZlZDQVYwQXdhazJubTB2UGRPY3M0V3FwaWJUMQpaRHErSW8rUFRuTmhzdUZjSjQxbTJuTUdYaGVTUEY2YzBoNStFbjJOUEFlbjlldE1iSnFadlp1S1U5TXFwd2RxClFsbFdZaFA1V05jUXlsS29zaEZObkxxcHROVnZSK2xmd1d4eWp4RGdzd0RpT0wzemNmajYxN1RsQmFHSzMyeWcKUDVkdzRsVnBOSEVhdFFZZnJVdDF6OE9Iby9XYVlhUFc1WmlVU0ZOUkt3YjRSenEybnRkYXJrYWw5TFpvOXpjegpoa3Exay9XVHN5Y0V4eXF2djNGU2F1L00vdEhWd0RpS2htakpNQlltbVBmRFFJekFpY3BJZkoyTEhCWUJFMWlTClFEZCtjM0tqekN4d0txUTQxWjRFT1FFcHZ1ZVNVMXVXcGJwQUNpcnQxYjdscUY1ZnhJeVh5aVMrK1FjQ0F3RUEKQVFLQ0FnQjZVVFNoWi9sZFBoN2JiMWkxUnVmS3RZRy9TbTNzV1pJN3hocUcwMEM0Yko1MEdjd2wxK3BYcVNySwpTemYrTTh4bXZJVUVhdDNnWkJ1eFdkTkRzR04rd0YySXJUUnBRRDNEMHlTUlAwSkF6OWNSQ1M3YStESUVBQXlqCi8rY2VzVHgzNU1rVEludFEveHZmR3hhYWhEQVNidC9DRXVPV2ZrTEZyWGxEbURvRCtub3lXTzgzcTdZVGJ4d00KbmdDekptRDFDazZmY2k4SEZWdXM2Vm1HODVIUDY0dVJOb1JLN1ZmbEc1NEowazJ4VjdIMERQUzJhMVpSWkgrOQpqbTZrSU1Ib0IyT2xiMEhsT0R4T1ZLNStLbzZ0Q1pwbG8yM1ZyY2hwc3d5NldkTlN5SnF5YXBUY3ZVZnF1WGxsCjc1a2V5ZkpCVGFITEJGZGZiZkVhVndvWTVISS8razl0KzNkWWlnT01KWVdBQVFIN29hS1hHaDcxZ0FQbUpHQkkKTzhyVHF5Sm9Fck8zSzl0Ui9aeUkybGtPNDEzL3FtYlYxckpvM0pFN3dmSGJSY1hGRW1wRGJKcXZVYkp1czNqbQp5bmg0eGVuME50eHdXUlgrREhXV2h4WGIvVzJRZ1Z6S0lVNWdUNzhLZ0MwYTlTVHFHTkUrWU5xNnVWeVJZZ2x4CjFoOWtuWURad0E1SDlJT08rT28yZTFjUnA5QkZQb0dyNVNEVXhLbzZ6c1JROCs2M2kyS1lUeTEvd3lNeWx0RzcKZGt3Zk1NQ0toMGUzWnN4SFFvM2h6RjlrZU5NbjhHZWZnNXl4N0VjSUU1a1BqMVlwdmNmRm1NaXJFVTRKbnlobQpzdm44aEdnS05NYk40bzFjOFhiYU8zVkQwYUVUTXorWTRQQzRoOVJrSTJZRFB5aEhNUUtDQVFFQXgvNk9hOTcxCkdSalM1QUV1Zm9qbWF6ZGdUTFlGc1VqK3dvZFNBa1hMdFovVU44TnpPbnVRdkhVaGg0TkQ1K3Q2YVlrcUlPZkgKNTVFRktPOVo3SWZ4b3dxcSt1TzFuV2xPaXpjcW1lRjBtaTFJeGV1OGN0SVdvNDRjSTBaWUo3bkJ2bnJDV0o3WAo3aEF6TjQzR3ZIdmdka0l3Zk1lQTcvU083cDh3eWFVMVVyTjZ5M2RqeHZ2dE11VS9NL0cyaWFML0ZZeVk0aExrCkN3N1g4aEswM3lZQllnOW5pTjJTa2c3d2dSVElGRVdCdUdLdmEzVSs2MFM3Y1RIYXg3VHlMMkQzeEtoTzF3aUUKazJiNVpPUThnNy9mVyttRExyZXZNNmI1bEp2Und5ak1TbEk3ZnhTTWxFU1RCMXlBQlgxSGhEWnNINngxblRQcApMOWcwQXUyd1ZRSmp5d0tDQVFFQTJIMCsrbmJWVGZ4TFNnNytSUENGWUJkdU9VMFVTZDVjMkhVamNxNHRnUG1XCnVSM0t6QjVSSzJCTmJzWHd0RzgySWd1UXVKZUFVbGEzTGRkTVVoS2xvclQxTWhoSUtQYlpuOXNMdFR1c3kyelQKNVh0d01IbXlyeDhnY3hVcnc4Ky9BOHQ0M3kyMkRSWFhUc052SVp4Y3ZKdlU4RFU4Snk1K0NNak9IRGs0Q053VQpQOE9kYWE2MGI0REhvRG41cTE1blZQU0NOT2FoV0NzNFkyd3B0Y3VubmVFWTd5dlhGNWk2RUZqczgrQjYxallrCjhwZHpnNm9ZWHFLNlM2M2w3alJnV251cVFxQWNDRUJzOEtXTnpHWGxmL3FvODQrT280Q1JXd01JRkU0di9Ic1kKaGVzY2lKTUkzSkl2Zk53aWN1UmJOWmh3cXJNNEFERzFseG44WnRid05RS0NBUUVBcFVuSlEzWGRjNFNFcDFRaQpyUWxRQmtTYUhreEJvQ2dJQlpYNVBVK1o4TjNMY3RyaUhPK0t5M2F5NDJDbGVzT3ZSQkhNODYwY0ZsSlF4V2dzCkZjUzAvRjhRdUpJQnc3c0k0eDRRNDJUbURaWm5rc3dsejIrNnJpb0JMMVl2L1lVVWp1eStPcWZ0SmgvVmRKQ0UKTTdyZDVGOEgyOWkydzVxSGxzZVNkdFZIb0xZZFFwUEZydXIvT3hVa2l6VzErMEx2TjB3Zi9waEdTSzFYNUFWNQozd04yR1NsS0ZGK3JoM001YWpWV3R3cExENnpmOWh2TWlIMGh2WWZLblVyNjdoVmlNUEk1VnBiL215Tjc4dHArCitSUlc4WXVvazYvVDZRaVROVE1peGZ5dCtxN0Q1VitDWC9mYzNEU2l5ZWFrZUt6UjU4dU0yUVBTTVd5cWI5RXAKN3RndXlRS0NBUUVBamc1QlVTREEveGRhWUJKT2p2WTB6c1VSTXRCOVM2dDV5UiswVHdBMEk3bWpTWDFmSVdtVApZWjhqc0ZoNmhpdWpuZHR3NzIrYWFHMDJiZ0lrdG9ZOTRmSlVJcmNFUXIwWU9Ha0gyYmg2dmxGL0NjcGg1NjB6CnJ1NEI0UUkzWVpua2daejJoNXY3SmNMN01WZlVpSDJON01Wa2lPcWx1aUFyMjUvSWY0U2NYRlB0aFpuYXBRcGEKcEFBZy9lYU5DZ0k4VStiTnVlRE1ab3FWeWNlajV3TG56aFZ5d3g1RldkcUIzVkE4ekJxMC8vTXZjM0FtQUhPUQo0aWh0amxOaDJWak5FUktzdW1OTmdheWt6NVFTNDlqSks1MVRWOThQZmdKVFh5RXlJQURlUkJLU0dPNGFIeFE4CmNHQU1nU1lDQk5vTGI3UEQybjhYZENrcU95aDJFeFZmTVFLQ0FRQTBlenQ3MkcwSHVKMVVSV082am54ZXA4bE0KcnA4UjdhOWhRSFlVNytOa1UwcUxVcTliZ2ZRb0QrVXMvUm9RRm5kZXczSWNrQ29yZlBRQS8vR2FFZXlrRE1mVAp2dUttWE9aMXNKL1VhazVQUHkzbmVoLzlQanZVSDdnRUFnL1JJRm4zck5lckVoV0lJSGU4OWNZK0xEcnFtTGRDCjJTalZyWEliUi90MFVnSmpJUU1xNEdxRDBtYy8zNEYzQmFFbVZWNDhrbVhmTGZvb3pxSWFkL0R5L1RVM2VGOUwKTmlPTmpObUVNSlgxUFVGdFNRS0lYbHlnNFVGQlgrMTdJZlZWUkxLOVRWcXFnQWNsQ0NkZXdkZ2l0b0x6ZnZwSgpsaUVKQ0RwZkRScTBwQis4SWF0RGJqUFdMMzJRdVhvZVV5aURMS1RNK0FPNlRGOEVLd0JFSEM4WWNaWlYKLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K'

pipeline{
  agent any
  stages{
    stage('SCM Checkout'){
      steps{
        git 'https://github.com/cpinochet/myapp-ansible'
      }
    }
    stage('printvar'){
      steps {
        wrap([$class: "MaskPasswordsBuildWrapper",
              varPasswordPairs: [[password: AWSCRIPKEY]]]) {
          echo "Password: ${AWSCRIPKEY}"
        }
      }
    }
    stage('Prework'){
      steps {
          sh '''
          # echo $AWSCRIPKEY | base64 -d > webserver_key.pem
          chmod 0400 webserver_key.pem
          ls -l webserver_key.pem
          export AWS_ACCESS_KEY_ID='AKIATDLZ4TN24KGT6NAV'
          export AWS_SECRET_ACCESS_KEY='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'
          echo -n "" > terra.log
          '''
      }
    }
    stage('Terraform init'){
      steps{
          sh'''
          terraform init
          terraform fmt
          terraform validate
          '''
      }
    }
    stage('Terraform plan'){
      steps{
          sh'''
          terraform plan
          '''
      }
    }
    stage('Terraform deploy'){
      steps{
          sh'''
          terraform apply --auto-approve | tee terra.log
          '''
      }
    }
    stage('post terra'){
      steps{
          sh'''
          echo "Updating ansible inventory file"
          EC2IP=$(cat terra.log | grep instance_public_ip | tail -n 1 | awk -F'"' '{print $2}')
          echo $EC2IP
          sed -i -e "s/EC2IP/${EC2IP}/g" dev.inv
          cat dev.inv
          '''
      }
    }
    stage('Ansible Playbook'){
      steps{
          sh'''
          cd /var/lib/jenkins/workspace/ansible/ansible_demo
          /usr/bin/ansible-playbook apache.yml -i dev.inv --private-key webserver_key.pem -u ec2-user
          '''
      }
    }
  }
  post{
    always {
      echo 'Limpiando espacio de trabajo....'
      cleanWs()
    }
  }
}